#!/bin/bash

if [ "$(cat /etc/installer_type)" == "online" ]; then
    # Online installer - no local images, gets from repo in /etc/steamos-atomupd/mirror
    BRANCH=$(cat /etc/installer_branch)
    source /etc/steamos-atomupd/mirror
    LATEST_URL="${MIRROR}/holoiso-images/$BRANCH/latest_$BRANCH.releasemeta"
    if kdialog --warningyesno "This is an online installer, it Requires internet connection to download the latest HoloISO image during installation. Make sure you are connected to the internet before proceeding. Do you want to continue?"; then
        echo "User chose to continue with online installer."
    else
        echo "User cancelled the installation."
        exit 1
    fi
    # put latest release to /etc/holoinstall/latest_$BRANCH.releasemeta
    sudo wget $LATEST_URL -O /etc/holoinstall/latest_$BRANCH.releasemeta
    source /etc/holoinstall/latest_$BRANCH.releasemeta
    echo $IMAGEFILE
    sudo holoiso_gui_download "${MIRROR}/holoiso-images/$BRANCH/${IMAGEFILE}.img.zst" "/etc/holoinstall/${IMAGEFILE}.img.zst"
    sudo holoiso_gui_download "${MIRROR}/holoiso-images/$BRANCH/${IMAGEFILE}.sha256" "/etc/holoinstall/${IMAGEFILE}.sha256"

    # verify img.zst sha256 and the downloaded sha256 file are the same
    sha256sum -c /etc/holoinstall/${IMAGEFILE}.sha256
    if [ $? -ne 0 ]; then
        kdialog --error "Checksum verification failed for the downloaded HoloISO image. The installation cannot proceed."
        exit 1
    fi

fi
holoiso_gui_installer